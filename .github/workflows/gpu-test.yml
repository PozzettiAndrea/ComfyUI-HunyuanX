name: GPU Tests

on:
  workflow_dispatch:

jobs:
  test:
    # this runner is your paid GPU runner in the org
    runs-on: linux-nvidia-gpu

    steps:
      - name: Checkout MeshCraft (this repo)
        uses: actions/checkout@v4
        with:
          path: ComfyUI-MeshCraft-CI

      - name: Checkout ComfyUI
        uses: actions/checkout@v4
        with:
          repository: comfyanonymous/ComfyUI
          path: ComfyUI

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
            python-version: '3.10'

      - name: Show GPU + CUDA info
        run: |
          echo "=== nvidia-smi ==="
          nvidia-smi || echo "no nvidia-smi?"
          echo "=== nvcc ==="
          nvcc --version || echo "nvcc not in PATH"

      - name: Install PyTorch (CUDA build)
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128
          python - << 'EOF'
          import torch
          print("Torch version:", torch.__version__)
          print("CUDA available:", torch.cuda.is_available())
          print("GPU count:", torch.cuda.device_count())
          EOF

      - name: Install ComfyUI dependencies
        working-directory: ComfyUI
        run: |
          pip install -r requirements.txt || true

      - name: Install MeshCraft as custom node
        run: |
          mkdir -p ComfyUI/custom_nodes/ComfyUI-MeshCraft
          rsync -a --exclude '.git' ComfyUI-MeshCraft-CI/ ComfyUI/custom_nodes/ComfyUI-MeshCraft/
          cd ComfyUI/custom_nodes/ComfyUI-MeshCraft
          pip install -r requirements.txt || true
          # dev/test extras (pytest etc.)
          pip install -r requirements-dev.txt || true
          pip install pytest pytest-cov pytest-mock

      - name: Build CUDA extensions (best effort)
        run: |
          set -xe
          # custom_rasterizer
          if [ -d ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/custom_rasterizer ]; then
            cd ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/custom_rasterizer
            echo "ðŸ”§ Compiling custom_rasterizer CUDA extension..."
            python setup.py install
            cd - >/dev/null
          else
            echo "custom_rasterizer not found, skipping"
          fi

          # DifferentiableRenderer (if present)
          if [ -d ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/DifferentiableRenderer ]; then
            cd ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/DifferentiableRenderer
            echo "ðŸ”§ Compiling DifferentiableRenderer CUDA/C++ extension..."
            python setup.py install
            cd - >/dev/null
          else
            echo "DifferentiableRenderer not found, skipping"
          fi

      - name: Run pytest on MeshCraft tests
        working-directory: ComfyUI
        run: |
          export PYTHONPATH=$PWD:$PYTHONPATH
          pytest custom_nodes/ComfyUI-MeshCraft/tests/ -v --tb=short

      - name: Import node map sanity check
        working-directory: ComfyUI/custom_nodes/ComfyUI-MeshCraft
        run: |
          export PYTHONPATH=$PWD/../..:$PYTHONPATH
          python - << 'EOF'
          import sys, import importlib.util, pathlib
          sys.path.insert(0, "../..")
          pkg_dir = pathlib.Path.cwd()
          spec = importlib.util.spec_from_file_location("ComfyUI-MeshCraft", pkg_dir / "__init__.py")
          pkg = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(pkg)
          print(f"âœ… Loaded {len(getattr(pkg, 'NODE_CLASS_MAPPINGS', {}))} nodes")
          EOF

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff
        continue-on-error: true
        run: |
          ruff check . --output-format=github
