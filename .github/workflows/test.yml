name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout ComfyUI-MeshCraft
      uses: actions/checkout@v4
      with:
        path: ComfyUI-MeshCraft

    - name: Checkout ComfyUI
      uses: actions/checkout@v4
      with:
        repository: comfyanonymous/ComfyUI
        path: ComfyUI

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install PyTorch (CPU)
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

    - name: Install ComfyUI dependencies
      working-directory: ComfyUI
      run: |
        pip install -r requirements.txt

    - name: Install MeshCraft as custom node
      run: |
        cp -r ComfyUI-MeshCraft ComfyUI/custom_nodes/
        cd ComfyUI/custom_nodes/ComfyUI-MeshCraft
        pip install -r requirements.txt

    - name: Compile CUDA extension
      working-directory: ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/custom_rasterizer
      run: |
        echo "üîß Compiling custom_rasterizer CUDA extension..."
        python setup.py install || echo "‚ö†Ô∏è  CUDA extension compilation skipped (no GPU in CI)"

    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov pytest-mock

    - name: Run tests
      working-directory: ComfyUI
      run: |
        # Set Python path to include ComfyUI
        export PYTHONPATH=$PWD:$PYTHONPATH
        # Run tests from the custom node
        pytest custom_nodes/ComfyUI-MeshCraft/tests/ -v --tb=short

    - name: Test node imports
      working-directory: ComfyUI
      run: |
        export PYTHONPATH=$PWD:$PYTHONPATH
        cd custom_nodes/ComfyUI-MeshCraft
        python -c "
import sys
sys.path.insert(0, '../..')
try:
    from custom_nodes.ComfyUI_MeshCraft import NODE_CLASS_MAPPINGS
    print(f'‚úÖ Successfully imported {len(NODE_CLASS_MAPPINGS)} nodes')
except Exception as e:
    print(f'‚ö†Ô∏è  Import failed: {e}')
    print('This is expected if dependencies are missing')
"

  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run Ruff
      run: |
        ruff check . --output-format=github
      continue-on-error: true
