name: Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
jobs:
  test:
    runs-on: linux-nvidia-gpu
    steps:
    - name: Checkout ComfyUI-MeshCraft
      uses: actions/checkout@v4
      with:
        path: ComfyUI-MeshCraft
    - name: Checkout ComfyUI
      uses: actions/checkout@v4
      with:
        repository: comfyanonymous/ComfyUI
        path: ComfyUI
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Check CUDA availability
      run: |
        nvidia-smi
        nvcc --version || echo "nvcc not in PATH"
    - name: Install PyTorch (GPU)
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128
    - name: Install ComfyUI dependencies
      working-directory: ComfyUI
      run: |
        pip install -r requirements.txt
    - name: Install MeshCraft as custom node
      run: |
        cp -r ComfyUI-MeshCraft ComfyUI/custom_nodes/
        cd ComfyUI/custom_nodes/ComfyUI-MeshCraft
        pip install -r requirements.txt
    - name: Compile CUDA extension
      working-directory: ComfyUI/custom_nodes/ComfyUI-MeshCraft/hy3dpaint/custom_rasterizer
      run: |
        echo "ðŸ”§ Compiling custom_rasterizer CUDA extension..."
        python setup.py install
    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov pytest-mock
    - name: Run tests
      working-directory: ComfyUI
      run: |
        export PYTHONPATH=$PWD:$PYTHONPATH
        pytest custom_nodes/ComfyUI-MeshCraft/tests/ -v --tb=short
    - name: Test node imports
      working-directory: ComfyUI/custom_nodes/ComfyUI-MeshCraft
      run: |
        export PYTHONPATH=$PWD/../..:$PYTHONPATH
        python -c "import sys; sys.path.insert(0, '../..'); exec(open('__init__.py').read()); print(f'âœ… Loaded {len(NODE_CLASS_MAPPINGS)} nodes')"
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install Ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    - name: Run Ruff
      run: |
        ruff check . --output-format=github
      continue-on-error: true